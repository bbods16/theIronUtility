name: CI

on:
  push:
    branches:
      - main
      - feature/*
    paths-ignore:
      - 'docs/**'
      - 'notebooks/**'
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install -e ".[dev]"

      - name: Lint with Ruff
        run: ruff check .

      - name: Format with Black
        run: black --check .

      - name: Sort imports with isort
        run: isort --check-only .

      - name: Type check with MyPy
        run: mypy src/

      - name: Run unit tests with Pytest
        run: pytest tests/unit

      # Placeholder for data-prepare (tiny slice)
      # - name: Prepare tiny data slice
      #   run: python scripts/prepare_data.py --tiny-slice

      # Placeholder for smoke-train (N=128 samples, 1 epoch)
      # - name: Smoke train
      #   run: python scripts/train.py --smoke-test --epochs 1 --batch-size 128

      # Placeholder for eval-subset
      # - name: Evaluate subset
      #   run: python scripts/evaluate.py --subset

      # Placeholder for export
      # - name: Export model
      #   run: python scripts/export.py --format onnx --subset

      - name: Run Bandit security scan
        run: bandit -r src/ -ll -f custom --msg-template "{abspath}:{line}: {test_id}[{severity}:{confidence}] {msg}"

      - name: Run Safety dependency scan
        run: safety check -r requirements.txt

      # - name: Run Gitleaks
      #   uses: zricethezav/gitleaks-action@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     config_path: .gitleaks.toml # Optional: path to gitleaks config file

      # - name: Perform CodeQL Analysis
      #   uses: github/codeql-action/analyze@v3
      #   with:
      #     category: "/language:python"
